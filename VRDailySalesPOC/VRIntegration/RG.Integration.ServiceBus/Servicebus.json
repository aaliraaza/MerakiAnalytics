{
  "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "serviceBusNamespaceName": {
      "type": "string"
    },
    "namespaceAuthorizationRuleName": {
      "type": "string"
    },

    //Topics
    "topics_salesinformation_name": {
      "type": "string"
    },

    "topics_retrysalesinformation_name": {
      "type": "string"
    },
    //Subscriptions
    "subscriptions_salesinformation_name": {
      "type": "string"
    },
    "subscriptions_retrysalesinformation_name": {
      "type": "string"
    },

    "serviceBusApiVersion": {
      "type": "string",
      "defaultValue": "2015-08-01"
    }
  },
  "variables": {
    "location": "[resourceGroup().location]",
    "sbVersion": "[parameters('serviceBusApiVersion')]",
    "namespaceAuthRuleName": "[concat(parameters('serviceBusNamespaceName'), concat('/', parameters('namespaceAuthorizationRuleName')))]",
    "nsAuthorizationRuleResourceId": "[resourceId('Microsoft.ServiceBus/namespaces/authorizationRules', parameters('serviceBusNamespaceName'), parameters('namespaceAuthorizationRuleName'))]"
  },
  "resources": [
    {
      "apiVersion": "[variables('sbVersion')]",
      "name": "[parameters('serviceBusNamespaceName')]",
      "type": "Microsoft.ServiceBus/namespaces",
      "location": "[variables('location')]",
      "kind": "Messaging",
      "sku": {
        "name": "Standard",
        "tier": "Standard"
      },
      "resources": [
        //Queue resource
        {
          "apiVersion": "[variables('sbVersion')]",
          "name": "[parameters('topics_salesinformation_name')]",
          "type": "topics",
          "dependsOn": [
            "[concat('Microsoft.ServiceBus/namespaces/', parameters('serviceBusNamespaceName'))]"
          ],
          "properties": {
            "path": "[parameters('topics_salesinformation_name')]",
            "maxSizeInMegabytes": "1024",
            "defaultMessageTimeToLive": "2.00:00:00",
            "lockDuration": "00:01:00",
            "enableDuplicateDetection": "true",
            "enablePartitioning": "true",
            "maxDeliveryCount": "5",
            "duplicateDetectionHistoryTimeWindow": "00:15:00"
          },
          "resources": [
          ]
        },
        {
          "apiVersion": "[variables('sbVersion')]",
          "name": "[parameters('topics_retrysalesinformation_name')]",
          "type": "topics",
          "dependsOn": [
            "[concat('Microsoft.ServiceBus/namespaces/', parameters('serviceBusNamespaceName'))]"
          ],
          "properties": {
            "path": "[parameters('topics_retrysalesinformation_name')]",
            "maxSizeInMegabytes": "1024",
            "defaultMessageTimeToLive": "2.00:00:00",
            "lockDuration": "00:01:00",
            "enableDuplicateDetection": "true",
            "enablePartitioning": "true",
            "maxDeliveryCount": "5",
            "duplicateDetectionHistoryTimeWindow": "00:15:00"
          },
          "resources": [
          ]
        },


        //Subscription resource
        {
          "type": "topics/subscriptions",
          "name": "[concat(parameters('topics_salesinformation_name'), '/', parameters('subscriptions_salesinformation_name'))]",
          "apiVersion": "[variables('sbVersion')]",
          "location": "West Europe",
          "properties": {
            "lockDuration": "00:00:30",
            "requiresSession": false,
            "defaultMessageTimeToLive": "14.00:00:00",
            "deadLetteringOnMessageExpiration": false,
            "deadLetteringOnFilterEvaluationExceptions": false,
            "messageCount": 0,
            "maxDeliveryCount": 10,
            "enableBatchedOperations": false,
            "status": "Active",
            "entityAvailabilityStatus": "Available"
          },
          "resources": [ ],
          "dependsOn": [
            "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNamespaceName'))]",
            "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusNamespaceName'), parameters('topics_salesinformation_name'))]"
          ]
        },
        {
          "type": "topics/subscriptions",
          "name": "[concat(parameters('topics_retrysalesinformation_name'), '/', parameters('subscriptions_retrysalesinformation_name'))]",
          "apiVersion": "[variables('sbVersion')]",
          "location": "West Europe",
          "properties": {
            "lockDuration": "00:00:30",
            "requiresSession": false,
            "defaultMessageTimeToLive": "14.00:00:00",
            "deadLetteringOnMessageExpiration": false,
            "deadLetteringOnFilterEvaluationExceptions": false,
            "messageCount": 0,
            "maxDeliveryCount": 10,
            "enableBatchedOperations": false,
            "status": "Active",
            "entityAvailabilityStatus": "Available"
          },
          "resources": [ ],
          "dependsOn": [
            "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNamespaceName'))]",
            "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusNamespaceName'), parameters('topics_retrysalesinformation_name'))]"
          ]
        }
      ]
    },
    {
      "apiVersion": "[variables('sbVersion')]",
      "name": "[variables('namespaceAuthRuleName')]",
      "type": "Microsoft.ServiceBus/namespaces/authorizationRules",
      "dependsOn": [ "[concat('Microsoft.ServiceBus/namespaces/', parameters('serviceBusNamespaceName'))]" ],
      "location": "[resourceGroup().location]",
      "properties": {
        "Rights": [ "Manage", "Listen", "Send" ]
      }
    }
  ],
  "outputs": {
        "NamespaceConnectionString": {
          "type": "string",
          "value": "[listkeys(variables('nsAuthorizationRuleResourceId'), variables('sbVersion')).primaryConnectionString]"
        },
        "NamespaceSharedAccessPolicyPrimaryKey": {
          "type": "string",
          "value": "[listkeys(variables('nsAuthorizationRuleResourceId'), variables('sbVersion')).primaryKey]"
        }
      }
    }
